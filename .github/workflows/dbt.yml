name: Fraud Detection CI/CD
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
jobs:
  test-dev:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v4
      with: { python-version: '3.11' }
    - run: pip install dbt-snowflake
    - name: Test in DEV
      env:
        SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
        SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
        SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
        SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
        SNOWFLAKE_WAREHOUSE: COMPUTE_WH
        SNOWFLAKE_DATABASE: FRAUD_DEV
      run: |
        dbt deps
        dbt run --target dev
        dbt test --target dev
 deploy-prod:
    needs: test-dev
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v4
    - name: Deploy to PROD BI Layer
      env:
        SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
        SNOWFLAKE_PROD_USER: ${{ secrets.SNOWFLAKE_PROD_USER }}
        SNOWFLAKE_PROD_PASSWORD: ${{ secrets.SNOWFLAKE_PROD_PASSWORD }}
        SNOWFLAKE_PROD_ROLE: ${{ secrets.SNOWFLAKE_PROD_ROLE }}
        SNOWFLAKE_PROD_WAREHOUSE: COMPUTE_WH_PROD
      run: |
        dbt deps
        dbt run --target prod
        dbt test --target prod
